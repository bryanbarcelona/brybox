name: Publish Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  id-token: write

jobs:
  tests:
    uses: ./.github/workflows/ci.yml

  publish:
    needs: tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      version: ${{ steps.cz.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - uses: actions/setup-python@v5
      - uses: astral-sh/setup-uv@v3

      - run: uv sync --all-extras --dev --frozen
      - run: uv tool install commitizen

      - name: Bump version, changelog & tag  (prepare only)
        id: cz
        uses: commitizen-tools/commitizen-action@0.26.0
        with:
          github_token: ${{ secrets.PAT }}
          git_name: "bryanbarcelona"
          git_email: "bryan.barcelona@gmail.com"
          push: false
          changelog: true

      - name: Build distribution packages
        if: steps.cz.outputs.version != ''
        run: uv build

      - name: Publish to PyPI
        if: steps.cz.outputs.version != ''
        run: uv publish

      - name: Push commit & tag to repository
        if: steps.cz.outputs.version != ''
        run: |
          git push origin HEAD:main
          git push origin v${{ steps.cz.outputs.version }}

  release:
    needs: publish
    if: ${{ needs.publish.outputs.version != '' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ needs.publish.outputs.version }}

      - uses: astral-sh/setup-uv@v3
      - run: uv build

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.publish.outputs.version }}
          generate_release_notes: true
          files: |
            dist/*.whl
            dist/*.tar.gz

      - name: Debug - Release created
        if: success()
        run: echo "::notice::âœ… Release v${{ needs.publish.outputs.version }} created successfully"
